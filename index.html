<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบทำบัญชีรายรับรายจ่าย - ร้านผลไม้</title>

    <!-- Firebase SDK (Compat version for easier integration) -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

    <!-- *** NEW: Add Chart.js Library *** -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* CSS ทั้งหมดเหมือนเดิม ไม่มีการเปลี่ยนแปลง */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            animation: float 20s linear infinite;
        }

        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(-20px, -20px) rotate(360deg); }
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }

        .nav-tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .nav-tab:hover {
            background: rgba(0,123,255,0.1);
            color: #007bff;
        }

        .nav-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
            color: white;
        }

        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%);
            color: #212529;
        }

        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255,193,7,0.3);
        }

        .btn-danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220,53,69,0.3);
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 1px solid #e9ecef;
        }

        .card h3 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
        }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card.income {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }

        .summary-card.expense {
            background: linear-gradient(135deg, #ff6b6b 0%, #ffa8a8 100%);
        }

        .summary-card.profit {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .summary-card.budget {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .summary-card h4 {
            font-size: 1.1em;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .summary-card .amount {
            font-size: 2.2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .transaction-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
        }

        .transaction-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            transition: background-color 0.3s ease;
        }

        .transaction-item:hover {
            background: #f8f9fa;
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-info {
            flex: 1;
        }

        .transaction-info h5 {
            color: #333;
            margin-bottom: 5px;
        }

        .transaction-info p {
            color: #6c757d;
            font-size: 0.9em;
        }

        .transaction-amount {
            font-weight: bold;
            font-size: 1.1em;
        }

        .transaction-amount.income {
            color: #28a745;
        }

        .transaction-amount.expense {
            color: #dc3545;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 12px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .progress-bar {
            width: 100%;
            height: 10px;
            background: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            transition: width 0.3s ease;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s ease, transform 0.3s ease;
        }
        
        .alert.show {
            opacity: 1;
            transform: translateY(0);
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .chart-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            margin-top: 20px;
        }

        .chart-box {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            height: 350px; /* Adjust height as needed */
        }
        
        @media (max-width: 992px) {
            .chart-container {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .summary-grid {
                grid-template-columns: 1fr;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .nav-tab {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🍎 ระบบทำบัญชีร้านผลไม้(fruitShopApp)</h1>
            <p>เปลี่ยนธุรกิจแค่ค้นหา (fruitShopApp) ในโค้ด แล้วแก้ 2 บรรทัด  จากนั้นไปแก้ไขประเภทรายรับรายจ่ายแค่นี้</p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showTab('dashboard')">📊 แดชบอร์ด</button>
            <button class="nav-tab" onclick="showTab('income')">💰 รายรับ</button>
            <button class="nav-tab" onclick="showTab('expense')">💸 รายจ่าย</button>
            <button class="nav-tab" onclick="showTab('reports')">📈 รายงาน</button>
            <button class="nav-tab" onclick="showTab('budget')">🎯 งบประมาณ</button>
            <button class="nav-tab" onclick="showTab('backup')">💾 จัดการข้อมูล</button>
            <button class="nav-tab" onclick="showTab('history')">📜 ประวัติทั้งหมด</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="summary-grid">
                <div class="summary-card income">
                    <h4>รายรับวันนี้</h4>
                    <div class="amount" id="todayIncome">0</div>
                    <small>บาท</small>
                </div>
                <div class="summary-card expense">
                    <h4>รายจ่ายวันนี้</h4>
                    <div class="amount" id="todayExpense">0</div>
                    <small>บาท</small>
                </div>
                <div class="summary-card profit">
                    <h4>กำไรวันนี้</h4>
                    <div class="amount" id="todayProfit">0</div>
                    <small>บาท</small>
                </div>
                <div class="summary-card budget">
                    <h4>งบประมาณคงเหลือ (เดือนนี้)</h4>
                    <div class="amount" id="remainingBudget">0</div>
                    <small>บาท</small>
                </div>
            </div>

            <div class="summary-grid">
                <div class="summary-card income">
                    <h4>รายรับเดือนนี้</h4>
                    <div class="amount" id="monthIncome">0</div>
                    <small>บาท</small>
                </div>
                <div class="summary-card expense">
                    <h4>รายจ่ายเดือนนี้</h4>
                    <div class="amount" id="monthExpense">0</div>
                    <small>บาท</small>
                </div>
                <div class="summary-card profit">
                    <h4>กำไรเดือนนี้</h4>
                    <div class="amount" id="monthProfit">0</div>
                    <small>บาท</small>
                </div>
                <div class="summary-card budget">
                    <h4>เป้าหมายกำไร (เดือนนี้)</h4>
                    <div class="amount" id="profitTarget">0</div>
                    <small>บาท</small>
                </div>
            </div>

            <div class="card">
                <h3>📊 ความคืบหน้าเป้าหมาย</h3>
                <div>
                    <label>ความคืบหน้ากำไรเดือนนี้: <span id="profitProgress">0%</span></label>
                    <div class="progress-bar">
                        <div class="progress-fill" id="profitProgressBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>📝 รายการล่าสุด</h3>
                <div id="recentTransactions" class="transaction-list">
                    <p>กำลังโหลดข้อมูล...</p>
                </div>
            </div>
        </div>

        <!-- Income Tab -->
        <div id="income" class="tab-content">
            <div class="card">
                <h3>💰 บันทึกรายรับ</h3>
                <form id="incomeForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>วันที่</label>
                            <input type="date" id="incomeDate" required>
                        </div>
                        <div class="form-group">
                            <label>ประเภทรายรับ</label>
                            <select id="incomeType" required>
                                <option value="">เลือกประเภท</option>
                                <option value="ขายผลไม้">ขายผลไม้</option>
                                <option value="อื่นๆ">อื่นๆ</option>
								
                            </select>
                        </div>
                        <div class="form-group">
                            <label>จำนวนเงิน (บาท)</label>
                            <input type="number" id="incomeAmount" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>รายละเอียด</label>
                            <textarea id="incomeDescription" rows="3" placeholder="รายละเอียดเพิ่มเติม"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-success">💰 บันทึกรายรับ</button>
                </form>
            </div>

            <div class="card">
                <h3>📋 รายการรายรับ</h3>
                <div id="incomeList" class="transaction-list">
                     <p>กำลังโหลดข้อมูล...</p>
                </div>
            </div>
        </div>

        <!-- Expense Tab -->
        <div id="expense" class="tab-content">
            <div class="card">
                <h3>💸 บันทึกรายจ่าย</h3>
                <form id="expenseForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>วันที่</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                        <div class="form-group">
                            <label>ประเภทรายจ่าย</label>
                            <select id="expenseType" required>
                                <option value="">เลือกประเภท</option>
                                <optgroup label="รายจ่ายประจำ">
                                    <option value="ค่าผลไม้">ค่าผลไม้</option>
                                    <option value="ค่าแรงพนักงาน">ค่าแรงพนักงาน</option>
                                    <option value="ค่าน้ำแข็ง">ค่าน้ำแข็ง</option>
                                </optgroup>
                                <optgroup label="รายจ่ายไม่ประจำ">
                                    <option value="ค่าถุงห่อ">ค่าถุงห่อ</option>
                                    <option value="กล่องน้ำจิ้ม">กล่องน้ำจิ้ม</option>
                                    <option value="อื่นๆ">อื่นๆ</option>
                                </optgroup>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>จำนวนเงิน (บาท)</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0" required>
                        </div>
                        <div class="form-group">
                            <label>รายละเอียด</label>
                            <textarea id="expenseDescription" rows="3" placeholder="รายละเอียดเพิ่มเติม"></textarea>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-danger">💸 บันทึกรายจ่าย</button>
                </form>
            </div>

            <div class="card">
                <h3>📋 รายการรายจ่าย</h3>
                <div id="expenseList" class="transaction-list">
                    <p>กำลังโหลดข้อมูล...</p>
                </div>
            </div>
        </div>

        <!-- Reports Tab -->
        <div id="reports" class="tab-content">
            <div class="card">
                <h3>📈 รายงานสรุป</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>เลือกช่วงเวลา</label>
                        <select id="reportPeriod">
                            <option value="today">วันนี้</option>
                            <option value="week">สัปดาห์นี้</option>
                            <option value="month" selected>เดือนนี้</option>
                            <option value="year">ปีนี้</option>
                            <option value="custom">กำหนดเอง</option>
                        </select>
                    </div>
                    <div class="form-group" id="customDateRange" style="display: none;">
                        <label>จาก - ถึง</label>
                        <div style="display: flex; gap: 10px;">
                           <input type="date" id="reportFromDate">
                           <input type="date" id="reportToDate">
                        </div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="generateReport()">🔍 สร้างรายงาน</button>
            </div>

            <div id="reportResult" class="card" style="display: none;">
                <h3>📊 ผลสรุปสำหรับช่วงเวลาที่เลือก</h3>
                <div class="summary-grid">
                    <div class="summary-card income">
                        <h4>รายรับรวม</h4>
                        <div class="amount" id="reportTotalIncome">0</div>
                        <small>บาท</small>
                    </div>
                    <div class="summary-card expense">
                        <h4>รายจ่ายรวม</h4>
                        <div class="amount" id="reportTotalExpense">0</div>
                        <small>บาท</small>
                    </div>
                    <div class="summary-card profit">
                        <h4>กำไร/ขาดทุน</h4>
                        <div class="amount" id="reportNetProfit">0</div>
                        <small>บาท</small>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-box">
                        <canvas id="incomeReportChart"></canvas>
                    </div>
                     <div class="chart-box">
                        <canvas id="expenseReportChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Budget Tab -->
        <div id="budget" class="tab-content">
            <div class="card">
                <h3>🎯 ตั้งงบประมาณและเป้าหมาย (รายเดือน)</h3>
                <form id="budgetForm">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>เป้าหมายรายรับรายเดือน (บาท)</label>
                            <input type="number" id="monthlyIncomeTarget" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>งบประมาณรายจ่ายรายเดือน (บาท)</label>
                            <input type="number" id="monthlyExpenseBudget" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>เป้าหมายกำไรรายเดือน (บาท)</label>
                            <input type="number" id="monthlyProfitTarget" step="0.01" min="0">
                        </div>
                        <div class="form-group">
                            <label>งบประมาณค่าวัตถุดิบ (บาท)</label>
                            <input type="number" id="materialBudget" step="0.01" min="0">
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">💾 บันทึกงบประมาณ</button>
                </form>
            </div>

            <div class="card">
                <h3>📊 สถานะงบประมาณปัจจุบัน (เดือนนี้)</h3>
                <div id="budgetStatus">
                    <div class="alert alert-warning">
                        กำลังโหลดข้อมูลงบประมาณ...
                    </div>
                </div>
            </div>
        </div>

        <!-- Backup Tab -->
        <div id="backup" class="tab-content">
             <div class="card">
                <h3>💾 การจัดการข้อมูล</h3>
                <p>คุณสามารถส่งออกข้อมูลทั้งหมดของแอปนี้เพื่อสำรองเก็บไว้ หรือนำเข้าข้อมูลจากไฟล์สำรองได้</p>
                <div style="margin-top: 20px;">
                    <button class="btn btn-success" onclick="exportData()">📊 ส่งออกข้อมูลเป็นไฟล์ JSON</button>
                    <button class="btn btn-warning" onclick="restoreData()">🔄 นำเข้าข้อมูล (เขียนทับข้อมูลแอปนี้)</button>
                </div>
                <div class="alert alert-warning" style="margin-top: 20px; position: static; opacity: 1; transform: none;">
                    <b>ข้อควรระวัง:</b> การ 'นำเข้าข้อมูล' จะเขียนทับข้อมูลทั้งหมดของ 'แอปบัญชีร้านอาหาร' ด้วยข้อมูลจากไฟล์ที่คุณเลือก (ข้อมูลโปรเจกต์อื่นจะปลอดภัย)
                </div>
                <hr style="margin: 20px 0;">
                <p style="color: #dc3545;"><b>คำเตือน:</b> การกระทำนี้จะลบข้อมูลของ 'แอปบัญชีร้านอาหาร' ทั้งหมดอย่างถาวรและไม่สามารถกู้คืนได้ (ข้อมูลโปรเจกต์อื่นจะปลอดภัย)</p>
                <button class="btn btn-danger" onclick="clearAllData()">🗑️ ล้างข้อมูลแอปนี้ทั้งหมด</button>
            </div>
        </div>

        <!-- History Tab -->
        <div id="history" class="tab-content">
            <div class="card">
                <h3>📜 ประวัติรายการทั้งหมด</h3>
                <p>ที่นี่คุณสามารถดูและกรองรายการทั้งหมดที่เคยบันทึกไว้ในระบบ</p>
                
                <div class="form-grid" style="margin-top: 20px;">
                    <div class="form-group">
                        <label>กรองตามประเภท</label>
                        <select id="historyFilterType">
                            <option value="all">ทั้งหมด</option>
                            <option value="income">เฉพาะรายรับ</option>
                            <option value="expense">เฉพาะรายจ่าย</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>จากวันที่</label>
                        <input type="date" id="historyFilterFrom">
                    </div>
                    <div class="form-group">
                        <label>ถึงวันที่</label>
                        <input type="date" id="historyFilterTo">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="renderFullHistory()">🔍 ค้นหา</button>
            </div>

            <div class="card">
                <h3>📋 ผลการค้นหา</h3>
                <div id="historyList" class="transaction-list">
                    <p>กรุณากดค้นหาเพื่อแสดงข้อมูล...</p>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- START: FIREBASE CONFIGURATION ---
const firebaseConfig = {
  apiKey: "AIzaSyAmAmceLCl40QTnWe3Prso-psMN6jNnY-U",
  authDomain: "supertest02-689bd.firebaseapp.com",
  databaseURL: "https://supertest02-689bd-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "supertest02-689bd",
  storageBucket: "supertest02-689bd.firebasestorage.app",
  messagingSenderId: "941347468855",
  appId: "1:941347468855:web:b19101cd3237d1896bb1b2",
  measurementId: "G-JP0SP2T4KG"
};
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const appRootRef = database.ref('fruitShopApp');
        const transactionsRef = appRootRef.child('transactions');
        const budgetRef = appRootRef.child('budget');
        // --- END: FIREBASE CONFIGURATION ---

        // Global variables
        let transactions = [];
        let budget = {
            monthlyIncomeTarget: 0,
            monthlyExpenseBudget: 0,
            monthlyProfitTarget: 0,
            materialBudget: 0
        };
        let incomeChartInstance = null;
        let expenseChartInstance = null;

        // --- NEW: Centralized Sorting Function ---
        function sortTransactions(a, b) {
            // Primary sort: by date, newest to oldest
            const dateComparison = new Date(b.date) - new Date(a.date);
            if (dateComparison !== 0) {
                return dateComparison;
            }
            // Secondary sort: by Firebase key (id), newest to oldest.
            // A newer key is lexicographically greater than an older one.
            return b.id.localeCompare(a.id);
        }

        // Load data when the page starts
        window.onload = function() {
            setTodayDate();
            listenForData();
            // Listen for changes on history filters to auto-search
            document.getElementById('historyFilterType').onchange = renderFullHistory;
            document.getElementById('historyFilterFrom').onchange = renderFullHistory;
            document.getElementById('historyFilterTo').onchange = renderFullHistory;
        };

        // Listen for data changes at the application root
        function listenForData() {
            appRootRef.on('value', (snapshot) => {
                const data = snapshot.val() || {};
                const transactionsData = data.transactions || {};
                transactions = Object.keys(transactionsData).map(key => ({ id: key, ...transactionsData[key] }));
                budget = data.budget || { monthlyIncomeTarget: 0, monthlyExpenseBudget: 0, monthlyProfitTarget: 0, materialBudget: 0 };
                
                updateBudgetForm();
                rerenderAll();
                console.log("Data from 'fruitShopApp' updated.");
            }, (error) => {
                console.error(error);
                showAlert('danger', 'ไม่สามารถเชื่อมต่อฐานข้อมูลได้');
            });
        }
        
        function rerenderAll() {
            updateDashboard();
            updateTransactionLists();
            updateBudgetStatus();
            renderFullHistory();
        }

        // Switch between tabs
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // Set default date to today
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('incomeDate').value = today;
            document.getElementById('expenseDate').value = today;
            document.getElementById('reportFromDate').value = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString().split('T')[0];
            document.getElementById('reportToDate').value = today;
            document.getElementById('historyFilterTo').value = today;
        }

        // Handle Income Form Submission
        document.getElementById('incomeForm').onsubmit = function(e) {
            e.preventDefault();
            const newIncome = {
                type: 'income',
                date: document.getElementById('incomeDate').value,
                category: document.getElementById('incomeType').value,
                amount: parseFloat(document.getElementById('incomeAmount').value),
                description: document.getElementById('incomeDescription').value || ""
            };
            
            transactionsRef.push(newIncome)
                .then(() => {
                    showAlert('success', 'บันทึกรายรับเรียบร้อย!');
                    document.getElementById('incomeForm').reset();
                    setTodayDate();
                })
                .catch(err => showAlert('danger', 'เกิดข้อผิดพลาด: ' + err.message));
        };

        // Handle Expense Form Submission
        document.getElementById('expenseForm').onsubmit = function(e) {
            e.preventDefault();
            const newExpense = {
                type: 'expense',
                date: document.getElementById('expenseDate').value,
                category: document.getElementById('expenseType').value,
                amount: parseFloat(document.getElementById('expenseAmount').value),
                description: document.getElementById('expenseDescription').value || ""
            };

            transactionsRef.push(newExpense)
                .then(() => {
                    showAlert('success', 'บันทึกรายจ่ายเรียบร้อย!');
                    document.getElementById('expenseForm').reset();
                    setTodayDate();
                })
                .catch(err => showAlert('danger', 'เกิดข้อผิดพลาด: ' + err.message));
        };

        // Handle Budget Form Submission
        document.getElementById('budgetForm').onsubmit = function(e) {
            e.preventDefault();
            const newBudget = {
                monthlyIncomeTarget: parseFloat(document.getElementById('monthlyIncomeTarget').value) || 0,
                monthlyExpenseBudget: parseFloat(document.getElementById('monthlyExpenseBudget').value) || 0,
                monthlyProfitTarget: parseFloat(document.getElementById('monthlyProfitTarget').value) || 0,
                materialBudget: parseFloat(document.getElementById('materialBudget').value) || 0
            };
            
            budgetRef.set(newBudget)
                .then(() => showAlert('success', 'บันทึกงบประมาณเรียบร้อย!'))
                .catch(err => showAlert('danger', 'เกิดข้อผิดพลาด: ' + err.message));
        };
        
        // Update the budget form fields
        function updateBudgetForm() {
            document.getElementById('monthlyIncomeTarget').value = budget.monthlyIncomeTarget || '';
            document.getElementById('monthlyExpenseBudget').value = budget.monthlyExpenseBudget || '';
            document.getElementById('monthlyProfitTarget').value = budget.monthlyProfitTarget || '';
            document.getElementById('materialBudget').value = budget.materialBudget || '';
        }

        // Update all dashboard values
        function updateDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const currentMonth = new Date().toISOString().substring(0, 7);
            const todayIncome = transactions.filter(t => t.type === 'income' && t.date === today).reduce((sum, t) => sum + t.amount, 0);
            const todayExpense = transactions.filter(t => t.type === 'expense' && t.date === today).reduce((sum, t) => sum + t.amount, 0);
            const todayProfit = todayIncome - todayExpense;
            const monthIncome = transactions.filter(t => t.type === 'income' && t.date.startsWith(currentMonth)).reduce((sum, t) => sum + t.amount, 0);
            const monthExpense = transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentMonth)).reduce((sum, t) => sum + t.amount, 0);
            const monthProfit = monthIncome - monthExpense;
            document.getElementById('todayIncome').textContent = formatMoney(todayIncome);
            document.getElementById('todayExpense').textContent = formatMoney(todayExpense);
            document.getElementById('todayProfit').textContent = formatMoney(todayProfit);
            document.getElementById('monthIncome').textContent = formatMoney(monthIncome);
            document.getElementById('monthExpense').textContent = formatMoney(monthExpense);
            document.getElementById('monthProfit').textContent = formatMoney(monthProfit);
            document.getElementById('profitTarget').textContent = formatMoney(budget.monthlyProfitTarget);
            const remainingBudget = (budget.monthlyExpenseBudget || 0) - monthExpense;
            document.getElementById('remainingBudget').textContent = formatMoney(remainingBudget);
            const profitProgress = budget.monthlyProfitTarget > 0 ? Math.min((monthProfit / budget.monthlyProfitTarget) * 100, 100) : 0;
            document.getElementById('profitProgress').textContent = Math.round(profitProgress) + '%';
            document.getElementById('profitProgressBar').style.width = profitProgress + '%';
            updateRecentTransactions();
        }

        function renderTransactionList(containerId, transactionArray) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            if (transactionArray.length === 0) {
                container.innerHTML = `<p>ยังไม่มีรายการ</p>`;
                return;
            }
            transactionArray.forEach(t => {
                const item = document.createElement('div');
                item.className = 'transaction-item';
                item.innerHTML = `
                    <div class="transaction-info">
                        <h5>${t.category}</h5>
                        <p>${formatDate(t.date)} - ${t.description || ''}</p>
                    </div>
                    <div class="transaction-amount ${t.type}">
                        ${t.type === 'income' ? '+' : '-'}${formatMoney(t.amount)}
                    </div>
                    <button class="delete-btn" onclick="deleteTransaction('${t.id}')">ลบ</button>
                `;
                container.appendChild(item);
            });
        }
        
        function updateRecentTransactions() {
            const recent = [...transactions]
                .sort(sortTransactions) // <-- FIXED: Use centralized sorting function
                .slice(0, 10);
            renderTransactionList('recentTransactions', recent);
        }
        
        function updateTransactionLists() {
            const allIncomes = [...transactions].filter(t => t.type === 'income').sort(sortTransactions); // <-- FIXED
            const allExpenses = [...transactions].filter(t => t.type === 'expense').sort(sortTransactions); // <-- FIXED
            renderTransactionList('incomeList', allIncomes);
            renderTransactionList('expenseList', allExpenses);
        }

        function deleteTransaction(id) {
            if (confirm('คุณต้องการลบรายการนี้ใช่หรือไม่?')) {
                transactionsRef.child(id).remove()
                    .then(() => showAlert('success', 'ลบรายการเรียบร้อย!'))
                    .catch(err => showAlert('danger', 'เกิดข้อผิดพลาด: ' + err.message));
            }
        }

        function updateBudgetStatus() {
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthExpense = transactions.filter(t => t.type === 'expense' && t.date.startsWith(currentMonth)).reduce((sum, t) => sum + t.amount, 0);
            const monthIncome = transactions.filter(t => t.type === 'income' && t.date.startsWith(currentMonth)).reduce((sum, t) => sum + t.amount, 0);
            const monthProfit = monthIncome - monthExpense;
            const container = document.getElementById('budgetStatus');
            container.innerHTML = `
                <div class="summary-grid">
                    <div class="summary-card ${monthIncome >= (budget.monthlyIncomeTarget || 0) ? 'income' : 'expense'}">
                        <h4>รายรับ vs เป้าหมาย</h4>
                        <div class="amount">${formatMoney(monthIncome)}</div>
                        <small>เป้าหมาย: ${formatMoney(budget.monthlyIncomeTarget)}</small>
                    </div>
                    <div class="summary-card ${monthExpense <= (budget.monthlyExpenseBudget || 0) ? 'income' : 'expense'}">
                        <h4>รายจ่าย vs งบประมาณ</h4>
                        <div class="amount">${formatMoney(monthExpense)}</div>
                        <small>งบประมาณ: ${formatMoney(budget.monthlyExpenseBudget)}</small>
                    </div>
                    <div class="summary-card ${monthProfit >= (budget.monthlyProfitTarget || 0) ? 'income' : 'expense'}">
                        <h4>กำไร vs เป้าหมาย</h4>
                        <div class="amount">${formatMoney(monthProfit)}</div>
                        <small>เป้าหมาย: ${formatMoney(budget.monthlyProfitTarget)}</small>
                    </div>
                </div>`;
        }
        
        function generateReport() {
            const period = document.getElementById('reportPeriod').value;
            let startDate, endDate;
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            switch (period) {
                case 'today':
                    startDate = endDate = todayStr;
                    break;
                case 'week':
                    const dayOfWeek = today.getDay() === 0 ? 6 : today.getDay() - 1;
                    const weekStart = new Date(today);
                    weekStart.setDate(today.getDate() - dayOfWeek);
                    startDate = weekStart.toISOString().split('T')[0];
                    endDate = todayStr;
                    break;
                case 'month':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
                    endDate = todayStr;
                    break;
                case 'year':
                    startDate = new Date(today.getFullYear(), 0, 1).toISOString().split('T')[0];
                    endDate = todayStr;
                    break;
                case 'custom':
                    startDate = document.getElementById('reportFromDate').value;
                    endDate = document.getElementById('reportToDate').value;
                    if (!startDate || !endDate) {
                        showAlert('warning', 'กรุณาเลือกช่วงวันที่');
                        return;
                    }
                    break;
            }
            const filtered = transactions.filter(t => t.date >= startDate && t.date <= endDate);
            const totalIncome = filtered.filter(t => t.type === 'income').reduce((s, t) => s + t.amount, 0);
            const totalExpense = filtered.filter(t => t.type === 'expense').reduce((s, t) => s + t.amount, 0);
            document.getElementById('reportTotalIncome').textContent = formatMoney(totalIncome);
            document.getElementById('reportTotalExpense').textContent = formatMoney(totalExpense);
            document.getElementById('reportNetProfit').textContent = formatMoney(totalIncome - totalExpense);
            document.getElementById('reportResult').style.display = 'block';
            showAlert('success', 'สร้างรายงานเรียบร้อย!');
            const incomeData = processCategoryData(filtered, 'income');
            const expenseData = processCategoryData(filtered, 'expense');
            createOrUpdateDoughnutChart('incomeReportChart', 'incomeChartInstance','สัดส่วนรายรับ', Object.keys(incomeData), Object.values(incomeData));
            createOrUpdateDoughnutChart('expenseReportChart','expenseChartInstance','สัดส่วนรายจ่าย', Object.keys(expenseData), Object.values(expenseData));
        }

        function processCategoryData(transactions, type) {
            const categoryData = {};
            transactions
                .filter(t => t.type === type)
                .forEach(t => {
                    if (categoryData[t.category]) {
                        categoryData[t.category] += t.amount;
                    } else {
                        categoryData[t.category] = t.amount;
                    }
                });
            return categoryData;
        }

        function createOrUpdateDoughnutChart(canvasId, instanceVar, title, labels, data) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            if (window[instanceVar]) {
                window[instanceVar].destroy();
            }
            window[instanceVar] = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.length > 0 ? labels : ['ไม่มีข้อมูล'],
                    datasets: [{
                        label: 'จำนวนเงิน (บาท)',
                        data: data.length > 0 ? data : [1],
                        backgroundColor: ['#4CAF50', '#FFC107', '#2196F3', '#F44336', '#9C27B0', '#FF9800', '#009688', '#795548', '#607D8B', '#E91E63'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: title, font: { size: 16 } }
                    }
                }
            });
        }

        function exportData() {
            appRootRef.once('value').then((snapshot) => {
                const dataToExport = snapshot.val();
                if (!dataToExport) {
                    showAlert('warning', 'ไม่มีข้อมูลให้ส่งออก');
                    return;
                }
                const dataStr = JSON.stringify(dataToExport, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `backup_ร้านผลไม้_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showAlert('success', 'ส่งออกข้อมูลเรียบร้อย!');
            });
        }

        function restoreData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json,application/json';
            input.onchange = e => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const data = JSON.parse(event.target.result);
                        if (typeof data.transactions === 'undefined' && typeof data.budget === 'undefined') {
                            showAlert('danger', 'ไฟล์ไม่ถูกต้อง! ไม่มีข้อมูล transactions หรือ budget');
                            return;
                        }
                        if (confirm('คุณต้องการเขียนทับข้อมูลทั้งหมดของแอปนี้ด้วยข้อมูลจากไฟล์นี้หรือไม่? (ข้อมูลโปรเจกต์อื่นจะปลอดภัย)')) {
                            if (confirm('ยืนยันครั้งสุดท้าย! ข้อมูลปัจจุบันของแอปนี้จะถูกแทนที่!')) {
                                appRootRef.set(data)
                                    .then(() => showAlert('success', 'นำเข้าและเขียนทับข้อมูลเรียบร้อยแล้ว!'))
                                    .catch(err => showAlert('danger', 'เกิดข้อผิดพลาดในการเขียนทับข้อมูล: ' + err.message));
                            }
                        }
                    } catch (error) {
                        showAlert('danger', 'ไฟล์ไม่ถูกต้องหรือเสียหาย ไม่สามารถอ่านข้อมูลได้');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm('คุณแน่ใจหรือไม่ว่าต้องการลบข้อมูลทั้งหมดของ "แอปบัญชีร้านผลไม้"? (ข้อมูลโปรเจกต์อื่นจะปลอดภัย)')) {
                 if (confirm('ยืนยันครั้งสุดท้ายเพื่อล้างข้อมูลของแอปนี้ทั้งหมด!')) {
                    appRootRef.set(null)
                        .then(() => showAlert('success', 'ล้างข้อมูลของแอปนี้เรียบร้อย!'))
                        .catch(err => showAlert('danger', 'เกิดข้อผิดพลาด: ' + err.message));
                 }
            }
        }

        function renderFullHistory() {
            const filterType = document.getElementById('historyFilterType').value;
            const filterFrom = document.getElementById('historyFilterFrom').value;
            const filterTo = document.getElementById('historyFilterTo').value;
            let filteredTransactions = [...transactions];
            if (filterType !== 'all') {
                filteredTransactions = filteredTransactions.filter(t => t.type === filterType);
            }
            if (filterFrom) {
                filteredTransactions = filteredTransactions.filter(t => t.date >= filterFrom);
            }
            if (filterTo) {
                filteredTransactions = filteredTransactions.filter(t => t.date <= filterTo);
            }
            filteredTransactions.sort(sortTransactions); // <-- FIXED: Sort the filtered results
            renderTransactionList('historyList', filteredTransactions);
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.classList.add('show'), 10);
            setTimeout(() => {
                 alertDiv.classList.remove('show');
                 setTimeout(() => alertDiv.remove(), 500);
            }, 4000);
        }

        function formatMoney(amount) {
            return new Intl.NumberFormat('th-TH', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount || 0);
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });
        }
        
        document.getElementById('reportPeriod').onchange = function() {
            document.getElementById('customDateRange').style.display = (this.value === 'custom') ? 'block' : 'none';
        };
    </script>
</body>
</html>